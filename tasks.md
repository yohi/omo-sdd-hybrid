### 💡 改善への提言 (Next Steps)

シニアエンジニアとして、以下のロードマップを提案します。

#### 1. APIアダプター層の導入 (保守性・信頼性)

OpenCodeのフック部分を直接ロジックに結合させるのではなく、薄いアダプター層を挟むことを推奨します。

* **提案**: `GatekeeperAdapter` インターフェースを定義し、OpenCode依存部分をそこに集約します。これにより、API変更時の修正範囲を限定できます。

#### 2. `tasks.md` のLint/Fixツールの実装 (使いやすさ)

Phase 1 移行をスムーズにするため、`package.json` のコメントにあった `sdd lint-tasks` や `migrate-tasks` を実装しましょう。

* **提案**: `specs/tasks.md` を解析し、バッククォートがないScope記述を自動的に修正するCLIツール（またはCustom Tool）を追加します。正規表現置換で9割は自動化できるはずです。

#### 3. Stateのバックアップと自動修復 (信頼性)

State破損時の挙動は `sdd_end_task` でクリアするようになっていますが、より安全側に倒すことができます。

* **提案**: `writeState` 時に、直前の正常なStateを `.bak` ファイルとして保存しておき、破損検知時に自動でロールバックするオプションを検討してください。

#### 4. Kiro統合の深化 (機能性)

**状態**: 🟢 実装完了

以下の機能を追加しました：

* **構造的ギャップ分析**:
  - `requirements.md` から要件（REQ-XXX形式）と受入条件を自動抽出
  - `design.md` から Impacted Files, Components, Dependencies を抽出
  - 実装カバレッジの計算（設計ファイルと実際の変更の比較）

* **意味的分析プロンプト生成**:
  - 抽出した要件と変更ファイルを基に、LLMへの分析依頼プロンプトを自動生成
  - OpenCodeエージェントに委譲する形で、依存関係を最小限に維持

* **使用方法**:
  ```bash
  sdd_validate_gap --deep              # 深度分析を有効化
  sdd_validate_gap --kiroSpec my-feat  # 特定の仕様を指定
  ```

* **追加ファイル**:
  - `.opencode/lib/spec-parser.ts` - 仕様ファイルからの構造化データ抽出
  - `.opencode/lib/coverage-analyzer.ts` - 設計カバレッジ分析
  - `kiro-utils.ts` 拡張 - `analyzeKiroGapDeep()`, `formatEnhancedKiroGapReport()`

---

### 🐛 既知の課題 (Known Issues)

#### テスト並列実行時の干渉問題

**状態**: 🟢 解決済み（動的パス解決実装 + 直列実行スクリプト追加）

**問題の詳細**:
Bunテストランナーの並列実行により、複数のテストファイルが同じ`.opencode/state/`ディレクトリを共有することでレースコンディションが発生します。

- **現象**: 全体テストスイート実行時に24個のテストが失敗（177個中）
- **根本原因**: テストファイル間での`writeState()`によるバックアップファイルの干渉、およびBunテストランナーにおける`process.env`の共有
- **現在の状態**: `bun run test:seq` により全テスト成功（177/177） ✅

**実施した対策**:
- ✅ `state-utils.ts`, `kiro-utils.ts`, 各ツールのパス定数を環境変数から動的に解決するように修正
- ✅ テストヘルパー `setupTestState()` でテストごとにユニークな一時ディレクトリを使用するように変更
- ✅ Bunの並列実行仕様（`process.env`共有）回避のため、`bun run test:seq` スクリプトを追加

**解決策の選択**:
解決策1（一意のパス）を実装したが、Bunのテストランナーが並列実行時に `process.env` を共有する仕様と思われるため、完全な分離には至らず。
解決策2（順次実行）を併用することで、全テストの安定通過を実現した。

**使用方法**:
```bash
# 全テストを順次実行（推奨）
bun run test:seq

# 個別実行（開発時）
bun test __tests__/target.test.ts
```

**参考情報**:
- 関連コミット: `77edc41` - 'recovered'ステータス処理とテスト並列実行対策
- 影響ファイル: `__tests__/**/*.test.ts` (18ファイル)
- 解決前のテスト結果: 個別実行で100%成功、並列全体実行で86.4%成功（153/177）
- 解決後のテスト結果: 順次実行（`bun run test:seq`）で100%成功（177/177）
