### 💡 改善への提言 (Next Steps)

シニアエンジニアとして、以下のロードマップを提案します。

#### 1. APIアダプター層の導入 (保守性・信頼性)

OpenCodeのフック部分を直接ロジックに結合させるのではなく、薄いアダプター層を挟むことを推奨します。

* **提案**: `GatekeeperAdapter` インターフェースを定義し、OpenCode依存部分をそこに集約します。これにより、API変更時の修正範囲を限定できます。

#### 2. `tasks.md` のLint/Fixツールの実装 (使いやすさ)

Phase 1 移行をスムーズにするため、`package.json` のコメントにあった `sdd lint-tasks` や `migrate-tasks` を実装しましょう。

* **提案**: `specs/tasks.md` を解析し、バッククォートがないScope記述を自動的に修正するCLIツール（またはCustom Tool）を追加します。正規表現置換で9割は自動化できるはずです。

#### 3. Stateのバックアップと自動修復 (信頼性)

State破損時の挙動は `sdd_end_task` でクリアするようになっていますが、より安全側に倒すことができます。

* **提案**: `writeState` 時に、直前の正常なStateを `.bak` ファイルとして保存しておき、破損検知時に自動でロールバックするオプションを検討してください。

#### 4. Kiro統合の深化 (機能性)

現在はスタブ実装ですが、ここを強化することで「仕様と実装の乖離」をより強力に検出できます。

* **提案**: 単にファイルの有無だけでなく、`requirements.md` の内容と実装コードのベクトル検索による類似度チェックなど、AIを活用した「意味的な検証」への拡張を視野に入れると、このツールの価値が飛躍的に高まります。

---

### 🐛 既知の課題 (Known Issues)

#### テスト並列実行時の干渉問題

**状態**: 🟢 解決済み（動的パス解決実装 + 直列実行スクリプト追加）

**問題の詳細**:
Bunテストランナーの並列実行により、複数のテストファイルが同じ`.opencode/state/`ディレクトリを共有することでレースコンディションが発生します。

- **現象**: 全体テストスイート実行時に24個のテストが失敗（177個中）
- **根本原因**: テストファイル間での`writeState()`によるバックアップファイルの干渉、およびBunテストランナーにおける`process.env`の共有
- **現在の状態**: `bun run test:seq` により全テスト成功（177/177） ✅

**実施した対策**:
- ✅ `state-utils.ts`, `kiro-utils.ts`, 各ツールのパス定数を環境変数から動的に解決するように修正
- ✅ テストヘルパー `setupTestState()` でテストごとにユニークな一時ディレクトリを使用するように変更
- ✅ Bunの並列実行仕様（`process.env`共有）回避のため、`npm run test:seq` スクリプトを追加

**解決策の選択**:
解決策1（一意のパス）を実装したが、Bunのテストランナーが並列実行時に `process.env` を共有する仕様と思われるため、完全な分離には至らず。
解決策2（順次実行）を併用することで、全テストの安定通過を実現した。

**使用方法**:
```bash
# 全テストを順次実行（推奨）
bun run test:seq

# 個別実行（開発時）
bun test __tests__/target.test.ts
```

**参考情報**:
- 関連コミット: `77edc41` - 'recovered'ステータス処理とテスト並列実行対策
- 影響ファイル: `__tests__/**/*.test.ts` (18ファイル)
- テストカバレッジ: 個別実行で100%成功、全体実行で86.4%成功（153/177）
