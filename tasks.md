### 💡 改善への提言 (Next Steps)

シニアエンジニアとして、以下のロードマップを提案します。

#### 1. APIアダプター層の導入 (保守性・信頼性)

OpenCodeのフック部分を直接ロジックに結合させるのではなく、薄いアダプター層を挟むことを推奨します。

* **提案**: `GatekeeperAdapter` インターフェースを定義し、OpenCode依存部分をそこに集約します。これにより、API変更時の修正範囲を限定できます。

#### 2. `tasks.md` のLint/Fixツールの実装 (使いやすさ)

Phase 1 移行をスムーズにするため、`package.json` のコメントにあった `sdd lint-tasks` や `migrate-tasks` を実装しましょう。

* **提案**: `specs/tasks.md` を解析し、バッククォートがないScope記述を自動的に修正するCLIツール（またはCustom Tool）を追加します。正規表現置換で9割は自動化できるはずです。

#### 3. Stateのバックアップと自動修復 (信頼性)

State破損時の挙動は `sdd_end_task` でクリアするようになっていますが、より安全側に倒すことができます。

* **提案**: `writeState` 時に、直前の正常なStateを `.bak` ファイルとして保存しておき、破損検知時に自動でロールバックするオプションを検討してください。

#### 4. Kiro統合の深化 (機能性)

現在はスタブ実装ですが、ここを強化することで「仕様と実装の乖離」をより強力に検出できます。

* **提案**: 単にファイルの有無だけでなく、`requirements.md` の内容と実装コードのベクトル検索による類似度チェックなど、AIを活用した「意味的な検証」への拡張を視野に入れると、このツールの価値が飛躍的に高まります。

---

### 🐛 既知の課題 (Known Issues)

#### テスト並列実行時の干渉問題

**状態**: 🔴 未解決（個別実行では全テスト成功）

**問題の詳細**:
Bunテストランナーの並列実行により、複数のテストファイルが同じ`.opencode/state/`ディレクトリを共有することでレースコンディションが発生します。

- **現象**: 全体テストスイート実行時に24個のテストが失敗（177個中）
- **根本原因**: テストファイル間での`writeState()`によるバックアップファイルの干渉
- **現在の状態**: 修正したテストファイルを個別実行すると全て成功 ✅

**再現手順**:
```bash
# 失敗する（並列実行）
bun test

# 成功する（個別実行）
bun test __tests__/e2e/acceptance.test.ts
bun test __tests__/tools/sdd_end_task.test.ts
bun test __tests__/lib/state-utils.test.ts
```

**試行した対策**:
- ✅ 各テストに`ensureNoBackups()`を追加
- ✅ 破損stateテストに`deleteAllBackups()`を追加
- ❌ Bunテストランナーに並列実行を制御するオプションが存在しない

**提案する解決策（優先度順）**:

1. **テストごとに一意のstateパスを使用** (推奨)
   - 各テストファイルで環境変数やモック設定により異なるstateディレクトリを使用
   - 実装影響: `STATE_DIR`の定数をテスト時のみ環境変数から読み込む
   - 工数: 中（1-2日）

2. **CIで各テストファイルを順次実行**
   - GitHub Actions等で`bun test <file>`を直列実行
   - 実装影響: CI設定のみ
   - 工数: 小（数時間）
   - デメリット: CI実行時間の増加

3. **排他制御の強化**
   - `readState()`/`writeState()`でファイルロックを使用
   - 実装影響: プロダクションコードの変更が必要
   - 工数: 大（3-5日）
   - デメリット: パフォーマンスへの影響

**参考情報**:
- 関連コミット: `77edc41` - 'recovered'ステータス処理とテスト並列実行対策
- 影響ファイル: `__tests__/**/*.test.ts` (18ファイル)
- テストカバレッジ: 個別実行で100%成功、全体実行で86.4%成功（153/177）
